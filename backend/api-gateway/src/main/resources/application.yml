server:
  port: 8080

spring:
  application:
    name: api-gateway

  # Redis para rate limiting
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:axonrh_redis_2026}

  cloud:
    gateway:
      # Configuracoes globais
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 100
            redis-rate-limiter.burstCapacity: 200
            redis-rate-limiter.requestedTokens: 1
            key-resolver: "#{@tenantKeyResolver}"

      # Rotas para microservicos
      routes:
        # Auth Service
        - id: auth-service
          uri: http://auth-service:8081
          predicates:
            - Path=/api/v1/auth/**
          filters:
            # - StripPrefix=2 # Removed as controller expects full path

        # Config Service
        - id: config-service
          uri: http://config-service:8888
          predicates:
            - Path=/api/v1/config/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Core Service - Setup & Import
        - id: core-service
          uri: http://core-service:8082
          predicates:
            - Path=/api/v1/setup/**
          filters:
            - name: JwtAuthFilter

        # Employee Service
        - id: employee-service
          uri: http://employee-service:8083
          predicates:
            - Path=/api/v1/employees/**, /api/v1/departments/**, /api/v1/positions/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Timesheet Service
        - id: timesheet-service
          uri: http://timesheet-service:8084
          predicates:
            - Path=/api/v1/timesheet/**, /api/v1/time-records/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Vacation Service
        - id: vacation-service
          uri: http://vacation-service:8085
          predicates:
            - Path=/api/v1/vacations/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Performance Service
        - id: performance-service
          uri: http://performance-service:8086
          predicates:
            - Path=/api/v1/performance/**, /api/v1/evaluations/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Learning Service
        - id: learning-service
          uri: http://learning-service:8087
          predicates:
            - Path=/api/v1/learning/**, /api/v1/courses/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # AI Assistant Service
        - id: ai-assistant-service
          uri: http://ai-assistant-service:8088
          predicates:
            - Path=/api/v1/ai/**, /api/v1/chat/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Notification Service
        - id: notification-service
          uri: http://notification-service:8089
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Analytics Service
        - id: analytics-service
          uri: http://analytics-service:8091
          predicates:
            - Path=/api/v1/analytics/**, /api/v1/reports/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

        # Integration Service
        - id: integration-service
          uri: http://integration-service:8090
          predicates:
            - Path=/api/v1/integrations/**, /api/v1/esocial/**
          filters:
            # - StripPrefix=2
            - name: JwtAuthFilter

      # CORS Global
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns:
              - "https://*.axonrh.com.br"
              - "http://localhost:*"
              - "http://92.112.176.177:*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - PATCH
              - DELETE
              - OPTIONS
            allowedHeaders:
              - "*"
            exposedHeaders:
              - "X-Request-Id"
              - "X-Tenant-Id"
            allowCredentials: true
            maxAge: 3600

# Actuator e metricas
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# Logging
logging:
  level:
    root: INFO
    com.axonrh: DEBUG
    org.springframework.cloud.gateway: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# JWT Configuration
jwt:
  secret: ${JWT_SECRET:axonrh-jwt-secret-key-change-in-production-2026}
  expiration: 28800000  # 8 horas em ms

# Rate Limiting por Tenant
rate-limit:
  default:
    requests-per-second: 100
    burst-capacity: 200
  plans:
    TRIAL:
      requests-per-second: 10
      burst-capacity: 20
    STARTER:
      requests-per-second: 50
      burst-capacity: 100
    PROFESSIONAL:
      requests-per-second: 100
      burst-capacity: 200
    ENTERPRISE:
      requests-per-second: 500
      burst-capacity: 1000
