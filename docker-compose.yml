version: '3.8'

x-backend-env: &backend-env
  DB_HOST: postgres
  DB_PORT: 5432
  DB_NAME: axonrh
  DB_USER: axonrh
  DB_PASSWORD: axonrh123
  REDIS_HOST: redis
  REDIS_PORT: 6379
  MINIO_ENDPOINT: http://minio:9000
  MINIO_ACCESS_KEY: axonrh
  MINIO_SECRET_KEY: axonrh123
  MONGODB_URI: mongodb://axonrh:axonrh123@mongodb:27017/axonrh_conversations?authSource=admin&connectTimeoutMS=30000&socketTimeoutMS=30000
  SPRING_FLYWAY_ENABLED: "false"
  SPRING_LIQUIBASE_ENABLED: "false"
  SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
  JAVA_TOOL_OPTIONS: "-Xms128m -Xmx512m"

x-backend-service: &backend-service
  image: maven:3.9.6-eclipse-temurin-21
  working_dir: /workspace/backend
  volumes:
    - ./backend:/workspace/backend
    - maven_repo:/root/.m2
  environment:
    <<: *backend-env
  depends_on:
    postgres:
      condition: service_healthy
    mongodb:
      condition: service_healthy
    redis:
      condition: service_healthy
    rabbitmq:
      condition: service_healthy
    minio:
      condition: service_healthy
  networks:
    - axonrh-network
  profiles:
    - backend

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: axonrh-postgres
    environment:
      POSTGRES_USER: axonrh
      POSTGRES_PASSWORD: axonrh123
      POSTGRES_DB: axonrh
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  # MongoDB for AI conversations
  mongodb:
    image: mongo:7
    container_name: axonrh-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: axonrh
      MONGO_INITDB_ROOT_PASSWORD: axonrh123
      MONGO_INITDB_DATABASE: axonrh
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: [ "CMD-SHELL", "mongosh --quiet --eval \"db.adminCommand('ping').ok\" | grep 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network

  # Redis for caching and sessions
  redis:
    image: redis:7-alpine
    container_name: axonrh-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping | grep PONG" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  # RabbitMQ for messaging
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: axonrh-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: axonrh
      RABBITMQ_DEFAULT_PASS: axonrh123
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: axonrh-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  # Kafka for messaging
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: axonrh-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog
    container_name: axonrh-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail --silent --show-error http://localhost:8025" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  # MinIO for file storage (S3 compatible)
  minio:
    image: minio/minio
    container_name: axonrh-minio
    environment:
      MINIO_ROOT_USER: axonrh
      MINIO_ROOT_PASSWORD: axonrh123
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail --silent --show-error http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 768M

  config-service:
    <<: *backend-service
    container_name: axonrh-config-service
    command: mvn -pl config-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8888:8888"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8888
    deploy:
      resources:
        limits:
          memory: 768M

  auth-service:
    <<: *backend-service
    container_name: axonrh-auth-service
    command: mvn -pl auth-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8081:8081"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8081
    deploy:
      resources:
        limits:
          memory: 1024M

  core-service:
    <<: *backend-service
    container_name: axonrh-core-service
    command: mvn -pl core-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8082:8082"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8082
    deploy:
      resources:
        limits:
          memory: 1024M

  employee-service:
    <<: *backend-service
    container_name: axonrh-employee-service
    env_file:
      - .env
    command: mvn -pl employee-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8083:8083"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8083
      AI_ASSISTANT_SERVICE_URL: http://ai-assistant-service:8088
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    deploy:
      resources:
        limits:
          memory: 1024M

  timesheet-service:
    <<: *backend-service
    container_name: axonrh-timesheet-service
    command: mvn -pl timesheet-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8084:8084"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8084
      EMPLOYEE_SERVICE_URL: http://employee-service:8083
      CORE_SERVICE_URL: http://core-service:8082
      CONFIG_SERVICE_URL: http://config-service:8888
    deploy:
      resources:
        limits:
          memory: 768M

  vacation-service:
    <<: *backend-service
    container_name: axonrh-vacation-service
    command: mvn -pl vacation-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8185:8085"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8085
      EMPLOYEE_SERVICE_URL: http://employee-service:8083
    deploy:
      resources:
        limits:
          memory: 768M

  performance-service:
    <<: *backend-service
    container_name: axonrh-performance-service
    command: mvn -pl performance-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8086:8086"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8086
      APPLICATION_SERVICES_EMPLOYEE_URL: http://employee-service:8083
    deploy:
      resources:
        limits:
          memory: 768M

  learning-service:
    <<: *backend-service
    container_name: axonrh-learning-service
    command: mvn -pl learning-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8187:8087"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8087
    deploy:
      resources:
        limits:
          memory: 768M

  ai-assistant-service:
    <<: *backend-service
    container_name: axonrh-ai-assistant-service
    command: mvn -pl ai-assistant-service -am spring-boot:run -Dspring-boot.run.fork=false
    env_file:
      - .env
    ports:
      - "8088:8088"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8088
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    deploy:
      resources:
        limits:
          memory: 768M

  notification-service:
    <<: *backend-service
    container_name: axonrh-notification-service
    command: mvn -pl notification-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8089:8089"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8089
    deploy:
      resources:
        limits:
          memory: 768M

  integration-service:
    <<: *backend-service
    container_name: axonrh-integration-service
    command: mvn -pl integration-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8090:8090"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8090
    deploy:
      resources:
        limits:
          memory: 768M

  benefits-service:
    <<: *backend-service
    container_name: axonrh-benefits-service
    command: mvn -pl benefits-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8091:8091"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8091
      EMPLOYEE_SERVICE_URL: http://axonrh-employee-service:8083
      PAYROLL_SERVICE_URL: http://axonrh-payroll-service:8092
    deploy:
      resources:
        limits:
          memory: 768M

  payroll-service:
    <<: *backend-service
    container_name: axonrh-payroll-service
    command: mvn -pl payroll-service -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8092:8092"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8092
      BENEFITS_SERVICE_URL: http://axonrh-benefits-service:8091
      EMPLOYEE_SERVICE_URL: http://employee-service:8083
      TIMESHEET_SERVICE_URL: http://timesheet-service:8084
      VACATION_SERVICE_URL: http://vacation-service:8085
      PERFORMANCE_SERVICE_URL: http://performance-service:8086
      CONFIG_SERVICE_URL: http://config-service:8888
      CORE_SERVICE_URL: http://core-service:8082
    deploy:
      resources:
        limits:
          memory: 768M

  api-gateway:
    <<: *backend-service
    container_name: axonrh-api-gateway
    command: mvn -pl api-gateway -am spring-boot:run -Dspring-boot.run.fork=false
    ports:
      - "8180:8080"
    environment:
      <<: *backend-env
      SPRING_FLYWAY_ENABLED: "true"
      SERVER_PORT: 8080
    deploy:
      resources:
        limits:
          memory: 1024M

  frontend:
    image: node:20-alpine
    container_name: axonrh-frontend
    working_dir: /workspace/frontend
    volumes:
      - ./frontend/web:/workspace/frontend
      - frontend_node_modules:/workspace/frontend/node_modules
    command: sh -c "npm install && npm run dev"
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
    depends_on:
      api-gateway:
        condition: service_started
    networks:
      - axonrh-network
    deploy:
      resources:
        limits:
          memory: 512M
    profiles:
      - frontend

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  zookeeper_data:
  kafka_data:
  minio_data:
  maven_repo:
  frontend_node_modules:


networks:
  axonrh-network:
    driver: bridge
