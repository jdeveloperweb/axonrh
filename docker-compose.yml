version: '3.8'

# =====================
# COMMON JVM SETTINGS
# =====================
x-backend-env: &backend-env
  DB_HOST: postgres
  DB_PORT: 5432
  DB_NAME: axonrh
  DB_USER: axonrh
  DB_PASSWORD: axonrh123
  REDIS_HOST: redis
  REDIS_PORT: 6379
  MINIO_ENDPOINT: http://minio:9000
  MINIO_ACCESS_KEY: axonrh
  MINIO_SECRET_KEY: axonrh123
  MONGODB_URI: mongodb://axonrh:axonrh123@mongodb:27017/axonrh_conversations?authSource=admin
  SPRING_FLYWAY_ENABLED: "false"
  SPRING_LIQUIBASE_ENABLED: "false"
  SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
  JAVA_OPTS: >
    -Xms128m -Xmx384m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200

# =====================
# BACKEND MEMORY LIMIT
# =====================
x-backend-limits: &backend-limits
  deploy:
    resources:
      limits:
        memory: 512M

# =====================
# BACKEND BASE SERVICE
# =====================
x-backend-service: &backend-service
  image: maven:3.9.6-eclipse-temurin-21
  working_dir: /workspace/backend
  volumes:
    - ./backend:/workspace/backend
    - maven_repo:/root/.m2
  environment:
    <<: *backend-env
  <<: *backend-limits
  depends_on:
    postgres:
      condition: service_healthy
    mongodb:
      condition: service_healthy
    redis:
      condition: service_healthy
    rabbitmq:
      condition: service_healthy
    minio:
      condition: service_healthy
  networks:
    - axonrh-network
  profiles:
    - backend

services:

  # =====================
  # DATABASES & INFRA
  # =====================
  postgres:
    image: postgres:15-alpine
    container_name: axonrh-postgres
    environment:
      POSTGRES_USER: axonrh
      POSTGRES_PASSWORD: axonrh123
      POSTGRES_DB: axonrh
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER" ]
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - axonrh-network

  mongodb:
    image: mongo:7
    container_name: axonrh-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: axonrh
      MONGO_INITDB_ROOT_PASSWORD: axonrh123
      MONGO_INITDB_DATABASE: axonrh
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: [ "CMD-SHELL", "mongosh --quiet --eval \"db.adminCommand('ping').ok\" | grep 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - axonrh-network

  redis:
    image: redis:7-alpine
    container_name: axonrh-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli ping | grep PONG" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M
    networks:
      - axonrh-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: axonrh-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: axonrh
      RABBITMQ_DEFAULT_PASS: axonrh123
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmq-diagnostics -q ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - axonrh-network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: axonrh-zookeeper
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - axonrh-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: axonrh-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 > /dev/null 2>&1" ]
      interval: 15s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - axonrh-network

  # =====================
  # BACKEND SERVICES
  # =====================
  config-service:
    <<: *backend-service
    container_name: axonrh-config-service
    command: mvn -pl config-service -am spring-boot:run
    ports:
      - "8888:8888"

  auth-service:
    <<: *backend-service
    container_name: axonrh-auth-service
    command: mvn -pl auth-service -am spring-boot:run
    ports:
      - "8081:8081"

  core-service:
    <<: *backend-service
    container_name: axonrh-core-service
    command: mvn -pl core-service -am spring-boot:run
    ports:
      - "8082:8082"

  employee-service:
    <<: *backend-service
    container_name: axonrh-employee-service
    command: mvn -pl employee-service -am spring-boot:run
    ports:
      - "8083:8083"

  timesheet-service:
    <<: *backend-service
    container_name: axonrh-timesheet-service
    command: mvn -pl timesheet-service -am spring-boot:run
    ports:
      - "8084:8084"

  vacation-service:
    <<: *backend-service
    container_name: axonrh-vacation-service
    command: mvn -pl vacation-service -am spring-boot:run
    ports:
      - "8185:8085"

  performance-service:
    <<: *backend-service
    container_name: axonrh-performance-service
    command: mvn -pl performance-service -am spring-boot:run
    ports:
      - "8086:8086"

  learning-service:
    <<: *backend-service
    container_name: axonrh-learning-service
    command: mvn -pl learning-service -am spring-boot:run
    ports:
      - "8187:8087"

  ai-assistant-service:
    <<: *backend-service
    container_name: axonrh-ai-assistant-service
    command: mvn -pl ai-assistant-service -am spring-boot:run
    ports:
      - "8088:8088"
    env_file:
      - .env

  notification-service:
    <<: *backend-service
    container_name: axonrh-notification-service
    command: mvn -pl notification-service -am spring-boot:run
    ports:
      - "8089:8089"

  integration-service:
    <<: *backend-service
    container_name: axonrh-integration-service
    command: mvn -pl integration-service -am spring-boot:run
    ports:
      - "8090:8090"

  api-gateway:
    <<: *backend-service
    container_name: axonrh-api-gateway
    command: mvn -pl api-gateway -am spring-boot:run
    ports:
      - "8180:8080"

  # =====================
  # FRONTEND
  # =====================
  frontend:
    image: node:20-alpine
    container_name: axonrh-frontend
    working_dir: /workspace/frontend
    volumes:
      - ./frontend/web:/workspace/frontend
      - frontend_node_modules:/workspace/frontend/node_modules
    command: sh -c "npm install && npm run dev"
    ports:
      - "3000:3000"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - axonrh-network
    profiles:
      - frontend

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  zookeeper_data:
  kafka_data:
  minio_data:
  maven_repo:
  frontend_node_modules:


networks:
  axonrh-network:
    driver: bridge
